# CANSAT FSW2 견고성 개선 사항

## 개요
앱 데이터가 들어오지 않아도 다른 기능들이 로그를 남기고 기록을 계속하도록 시스템을 개선했습니다.

## 주요 개선 사항

### 1. 메인 시스템 (main.py) 개선

#### 앱 상태 모니터링 시스템
- **앱 헬스 체크**: 5초마다 모든 앱의 상태를 모니터링
- **실패 카운터**: 각 앱별로 연속 실패 횟수를 추적
- **자동 재시작**: 죽은 앱을 자동으로 재시작 (최대 3회)
- **재시작 쿨다운**: 재시작 후 30초 대기로 과도한 재시작 방지

#### 개선된 메시지 처리
- **브로큰 파이프 처리**: 파이프 오류 시 자동 재시작
- **메시지 전송 실패 추적**: 실패 횟수에 따른 앱 상태 업데이트
- **시스템 상태 로깅**: 30초마다 전체 시스템 상태를 로깅

#### 앱 재시작 메커니즘
```python
def restart_app(appID):
    # 재시작 시도 횟수 제한
    # 쿨다운 기간 체크
    # 기존 프로세스 정리
    # 새 프로세스 시작
    # 상태 업데이트
```

### 2. IMU 앱 (imu/imuapp.py) 개선

#### 센서 오류 처리 강화
- **I/O 오류 특별 처리**: Input/output error 발생 시 센서 재초기화 시도
- **연속 오류 추적**: 10회 연속 오류 시 센서 비정상 상태로 표시
- **자동 복구**: 센서 재초기화를 통한 자동 복구 (최대 5회)

#### 더미 데이터 모드
- **센서 연결 실패 시**: 더미 데이터로 계속 실행
- **데이터 유효성 검사**: None 데이터 처리 및 이전 값 유지
- **상태별 로깅**: 센서/더미/오류 상태를 구분하여 로깅

#### 개선된 로깅 시스템
- **고주파 로깅**: 10Hz로 센서 데이터 로깅
- **하우스키핑 로깅**: 1Hz로 시스템 상태 로깅
- **오류 로깅**: 모든 오류를 별도 파일에 기록
- **긴급 로깅**: 강제 종료 시에도 로그 저장

### 3. 로깅 시스템 개선

#### 다중 로그 파일
```
logs/imu/
├── high_freq_imu_log.csv    # 고주파 센서 데이터
├── hk_log.csv              # 하우스키핑 데이터
└── error_log.csv           # 오류 로그
```

#### 로그 데이터 구조
- **타임스탬프**: 밀리초 단위 정확한 시간 기록
- **데이터 타입**: SENSOR/DUMMY/ERROR 구분
- **센서 상태**: healthy/unhealthy 상태 표시
- **오류 카운터**: 연속 오류 횟수 추적

### 4. 오류 처리 전략

#### 계층적 오류 처리
1. **센서 레벨**: I/O 오류 → 센서 재초기화
2. **앱 레벨**: 프로세스 죽음 → 앱 재시작
3. **시스템 레벨**: 전체 시스템 상태 모니터링

#### 우아한 성능 저하
- **점진적 기능 축소**: 센서 실패 → 더미 데이터 → 로깅만
- **핵심 기능 보존**: 로깅과 통신은 최대한 유지
- **복구 가능성**: 센서 복구 시 자동으로 정상 모드로 전환

## 테스트 방법

### 1. 자동 테스트
```bash
python3 test_robustness.py
```

### 2. 수동 테스트
1. **IMU 센서 분리**: 센서 연결을 물리적으로 분리
2. **더미 데이터 확인**: 로그에서 "DUMMY" 데이터 확인
3. **센서 재연결**: 센서를 다시 연결
4. **복구 확인**: 로그에서 "SENSOR" 데이터로 복구 확인

### 3. 로그 확인
```bash
# 실시간 로그 모니터링
tail -f logs/imu/high_freq_imu_log.csv

# 오류 로그 확인
cat logs/imu/error_log.csv

# 시스템 상태 확인
cat logs/imu/hk_log.csv
```

## 성능 개선 효과

### 1. 시스템 안정성
- **단일 앱 실패**: 다른 앱들에 영향 없음
- **센서 오류**: 시스템 전체 중단 없음
- **자동 복구**: 수동 개입 없이 자동 복구

### 2. 데이터 보존
- **연속 로깅**: 오류 상황에서도 로그 기록 계속
- **상태 추적**: 센서/앱 상태 변화 추적
- **오류 분석**: 상세한 오류 로그로 문제 진단 가능

### 3. 운영 효율성
- **자동화**: 수동 재시작 불필요
- **모니터링**: 실시간 시스템 상태 확인
- **진단**: 오류 원인 분석 용이

## 설정 가능한 매개변수

### main.py
```python
app_failure_threshold = 5      # 앱 실패 임계값 (초)
app_restart_cooldown = 30      # 재시작 쿨다운 (초)
health_check_interval = 5.0    # 헬스 체크 간격 (초)
status_log_interval = 30.0     # 상태 로깅 간격 (초)
```

### imuapp.py
```python
max_consecutive_errors = 10    # 연속 오류 임계값
_max_sensor_recovery_attempts = 5  # 센서 복구 시도 횟수
```

## 향후 개선 계획

1. **다른 앱들에도 동일한 패턴 적용**
2. **웹 기반 모니터링 대시보드 추가**
3. **원격 진단 및 복구 기능**
4. **예측적 유지보수 시스템**

## 결론

이번 개선을 통해 CANSAT FSW2는 다음과 같은 견고성을 확보했습니다:

- **단일 실패 격리**: 한 앱의 실패가 전체 시스템에 영향을 주지 않음
- **자동 복구**: 대부분의 오류 상황에서 자동으로 복구
- **연속 운영**: 센서 오류 상황에서도 시스템이 계속 작동
- **상세한 모니터링**: 모든 상태 변화를 추적하고 기록

이러한 개선으로 CANSAT 임무 중 발생할 수 있는 다양한 오류 상황에 대해 안정적으로 대응할 수 있게 되었습니다. 